# 说话岛助手 - 更新功能说明

## 功能概述

说话岛助手现已集成自动更新功能，可以在应用内检查和安装更新。此功能基于 Tauri 的更新插件实现。

## 已实现的功能

### 1. 后端更新功能 (Rust)

在 `src-tauri/src/lib.rs` 中添加了以下功能：

- **更新器插件初始化**: 使用 `tauri_plugin_updater::Builder::new().build()` 初始化更新器
- **检查更新命令**: `check_for_updates` - 检查是否有可用更新
- **安装更新命令**: `install_update` - 下载并安装更新

### 2. 前端更新架构 (React)

采用了更合理的组件架构，将更新功能分离到专门的模块：

- **更新钩子** (`src/hooks/useAppUpdater.ts`):
  - 封装了所有更新相关的状态和逻辑
  - 提供检查更新和安装更新的方法
  - 在应用启动时自动检查更新

- **更新通知组件** (`src/components/UpdateNotification.tsx`):
  - 在应用顶部显示更新提示
  - 提供一键安装更新的功能
  - 可被用户关闭

- **应用级集成** (`src/App.tsx`):
  - 在应用根组件中管理更新功能
  - 确保更新逻辑在应用初始化时执行
  - 全局显示更新通知

### 3. 配置文件设置

在 `src-tauri/tauri.conf.json` 中已配置：

- **更新器插件**: 已启用并配置
- **创建更新工件**: `createUpdaterArtifacts: true` - 打包时自动生成更新包
- **公钥配置**: 已配置用于验证更新包的公钥

## 使用方法

### 对于用户

1. **自动检查**: 应用启动3秒后会自动检查更新
2. **更新通知**: 如果有可用更新，会在应用右上角显示绿色通知条
3. **一键更新**: 点击通知中的"立即更新"按钮即可下载并安装更新
4. **稍后提醒**: 可以点击"稍后提醒"关闭通知，下次启动应用时会再次提醒

### 对于开发者

#### 打包并生成更新包

1. **开发版本打包**:
   ```bash
   pnpm run tauri:build-debug
   ```

2. **生产版本打包**:
   ```bash
   pnpm run tauri:build
   ```

3. **Windows 安装包**:
   ```bash
   pnpm run build:win-installer
   ```

#### 更新包位置

打包完成后，更新包会生成在以下位置：
- Windows: `src-tauri/target/release/bundle/`
- 更新签名文件: `src-tauri/target/release/bundle/msi/` (对于 MSI 安装包)

#### 架构优势

1. **关注点分离**: 更新逻辑与业务功能分离，提高代码可维护性
2. **全局管理**: 更新功能在应用级别管理，确保所有页面都能访问
3. **用户体验**: 非侵入式的通知方式，不影响用户正常操作
4. **可复用性**: 更新钩子可以在任何组件中使用，便于扩展

#### 架构优势

1. **关注点分离**: 更新逻辑与业务功能分离，提高代码可维护性
2. **全局管理**: 更新功能在应用级别管理，确保所有页面都能访问
3. **用户体验**: 非侵入式的通知方式，不影响用户正常操作
4. **可复用性**: 更新钩子可以在任何组件中使用，便于扩展

#### 发布更新流程

1. 更新 `src-tauri/tauri.conf.json` 中的版本号
2. 运行打包命令生成新的安装包和更新包
3. 将更新包上传到您的更新服务器
4. 配置更新服务器以提供更新信息

## 更新服务器配置

Tauri 更新需要一个提供更新信息的 JSON 服务器。您需要设置一个返回以下格式 JSON 的端点：

```json
{
  "version": "0.2.0",
  "notes": "新版本更新内容",
  "pub_date": "2023-12-25T10:00:00Z",
  "platforms": {
    "windows-x86_64": {
      "signature": "更新包签名",
      "url": "https://your-server.com/updates/app-0.2.0-x86_64-pc-windows-msvc.zip"
    }
  }
}
```

## 注意事项

1. **公钥配置**: 确保 `tauri.conf.json` 中的公钥与用于签名更新包的私钥匹配
2. **版本号**: 每次发布新版本时必须递增版本号
3. **网络权限**: 应用需要有网络权限才能检查和下载更新
4. **用户权限**: 在 Windows 上，安装更新可能需要管理员权限

## 故障排除

### 检查更新失败

1. 检查网络连接
2. 确认更新服务器 URL 配置正确
3. 查看控制台错误信息

### 安装更新失败

1. 确保有足够的磁盘空间
2. 检查是否有足够的权限
3. 确认更新包签名验证通过

### 更新包生成失败

1. 检查 `tauri.conf.json` 中的 `createUpdaterArtifacts` 是否为 `true`
2. 确认版本号已正确更新
3. 检查构建过程是否有错误

## 开发建议

1. 在开发阶段，可以使用调试版本测试更新功能
2. 生产环境发布前，务必测试完整的更新流程
3. 考虑实现回滚机制，以防更新失败
4. 为用户提供更新日志，说明新功能和修复内容